if(!PHP2Go.included[PHP2Go.baseUrl+'form/autocompletefield.js']){PHP2Go.include(PHP2Go.baseUrl+'ajax.js');AutoCompleteField=function(id,options){this.ComponentField($(id),'AutoCompleteField');this.autoComplete=$(id+'_choices');this.options=options||{};this.choiceCount=0;this.choiceItems=[];this.choosing=false;this.overChoices=false;this.fldChanged=false;this.selectedIndex=-1;this.lastValue=null;this.timer=null;this.setup();};AutoCompleteField.extend(ComponentField,'ComponentField');AutoCompleteField.prototype.setup=function(){var self=this,op=this.options;this.fld.component=this;this.autoComplete.style.zIndex=1000;op.ajax=!!op.ajax;op.ajaxOptions=(typeof(op.ajaxOptions)!='object'?{}:op.ajaxOptions);op.ajaxOptions.params=op.ajaxOptions.params||{};op.url=op.url||document.location.pathname;op.choices=(op.ajax||!op.choices||!op.choices.length?[]:op.choices);op.delay=op.delay||0.3;op.maxChoices=op.maxChoices||10;op.minChars=op.minChars||2;op.ignoreCase=Object.ifUndef(op.ignoreCase,true);op.fullSearch=!!op.fullSearch;op.autoSelect=!!op.autoSelect;op.incremental=!!op.incremental;op.separator=op.separator||',';op.style={normal:(op.style||{}).normal||'autoCompleteNormal',selected:(op.style||{}).selected||'autoCompleteSelected',hover:(op.style||{}).hover||'autoCompleteHover'};if(op.throbber){if((op.throbber.constructor||$EF)==Throbber)op.throbber=args.throbber;else op.throbber=new Throbber({element:op.throbber,centralize:false});}this.fld.setAttribute('autocomplete','off');Event.addListener(this.fld,'keydown',function(e){self.keyDownHandler(e);});Event.addListener(this.fld,'keyup',function(e){self.keyUpHandler(e);});Event.addListener(this.fld,'blur',function(e){self.blurHandler(e);});Event.addListener(this.autoComplete,'mouseover',function(e){self.mouseHandler(e);});Event.addListener(this.autoComplete,'mouseout',function(e){self.mouseHandler(e);});Event.addListener(this.autoComplete,'scroll',function(e){self.mouseHandler(e);});};AutoCompleteField.prototype.getValue=function(){if(this.options.incremental){if(this.fld.value.trim()=='')return null;var res=this.fld.value.split(this.options.separator).valid(function(item,idx){var val=item.trim();return(val.empty()?null:val);});return(res.empty()?null:res);}return(this.fld.value.trim());};AutoCompleteField.prototype.setValue=function(val){(this.incremental&&Object.isArray(val))&&(val=val.split(this.separator+' '));this.fld.value=val;};AutoCompleteField.prototype.clear=function(){this.fld.value='';this.hideChoices();};AutoCompleteField.prototype.isEmpty=function(){var val=this.getValue();return(val==null||val=='');};AutoCompleteField.prototype.disable=function(){this.fld.disabled=true;this.hideChoices();};AutoCompleteField.prototype.showChoices=function(){var elm=this.autoComplete;if(!elm.isVisible()){var pos=this.fld.getPosition();var dim=this.fld.getDimensions();elm.show();if(isFinite(this.options.height))elm.resizeTo(dim.width,this.options.height);else elm.setStyle('width',dim.width);elm.moveTo(pos.x,pos.y+dim.height);}};AutoCompleteField.prototype.hideChoices=function(){this.autoComplete.hide();this.choosing=false;};AutoCompleteField.prototype.getChoices=function(){var self=this,tok=this.getLastToken();var op=this.options,ign=op.ignoreCase;if(op.ajax){var ajax=new AjaxRequest(op.url,op.ajaxOptions);ajax.async=true;ajax.headers['X-P2g-AutoComplete']='1';ajax.addParam(this.fld.name,tok);ajax.addParam('ignorecase',(ign?1:0));ajax.addParam('fullsearch',(op.fullSearch?1:0));ajax.bind('onSuccess',function(resp){if(resp.responseText.match(/^<ul/i))self.updateChoices(resp.responseText);else self.updateChoices(null);});ajax.bind('onError',function(resp){self.updateChoices(null);});ajax.bind('onException',function(resp){self.updateChoices(null);});(op.throbber)&&(op.throbber.show());ajax.send();}else{var id,item,pos,cnt=0;var tok=this.getLastToken(),res='';for(var i=0;i<op.choices.length;i++){item=op.choices[i];pos=(ign?item.toLowerCase():item).indexOf(ign?tok.toLowerCase():tok);if(pos!=-1){if(pos==0){cnt++;res+="<li><b><u>"+item.substring(0,tok.length)+"</u></b>"+item.substring(tok.length)+"</li>";}else if(op.fullSearch){cnt++;res+="<li>"+item.substring(0,pos)+"<b><u>"+item.substring(pos,pos+tok.length)+"</u></b>"+item.substring(pos+tok.length)+"</li>";}}if(cnt==op.maxChoices)break;}(res!='')&&(res="<ul>"+res+"</ul>");this.updateChoices(res);}};AutoCompleteField.prototype.updateChoices=function(html){(this.options.ajax&&this.options.throbber)&&(this.options.throbber.hide());if(!this.fldChanged){this.autoComplete.update(html);if(html!=''){var i,item,self=this;this.choiceItems=this.autoComplete.getElementsByTagName('li');this.choiceCount=this.choiceItems.length;if(this.options.autoSelect&&this.choiceCount==1){this.chooseByIndex(0);}else{for(i=0;i<this.choiceItems.length;i++){item=this.choiceItems[i];item.className=this.options.style.normal;item.index=i;Event.addListener(item,'mouseover',function(e){self.choiceHoverHandler($EV(e));});Event.addListener(item,'mouseout',function(e){self.choiceHoverHandler($EV(e));});Event.addListener(item,'click',function(e){self.choiceClickHandler($EV(e));});}this.choosing=true;this.selectedIndex=-1;this.navigate(1);}}else{this.choosing=false;this.hideChoices();}}};AutoCompleteField.prototype.keyDownHandler=function(e){e=$EV(e);if(this.choosing){switch(e.key()){case 9:case 13:this.chooseByIndex(this.selectedIndex);e.stop();return;case 27:this.hideChoices();e.stop();return;case 40:this.navigate(1);e.stop();return;case 38:this.navigate(-1);e.stop();return;}}this.lastValue=this.fld.value;clearTimeout(this.timer);};AutoCompleteField.prototype.keyUpHandler=function(e){var k=$K(e);this.fldChanged=(this.fld.value!=this.lastValue);if('#9#13#16#17#33#34#35#36#37#38#39#40#45#127#4098#'.indexOf('#'+k+'#')!=-1||!this.fldChanged)return;clearTimeout(this.timer);this.timer=this.timerHandler.bind(this).delay(this.options.delay*1000);};AutoCompleteField.prototype.timerHandler=function(){this.fldChanged=false;if(this.getLastToken().length>=this.options.minChars){this.getChoices();}else{this.choosing=false;this.hideChoices();}};AutoCompleteField.prototype.blurHandler=function(e){var self=this;var k=$K(e);setTimeout(function(){if(!self.overChoices||k==9)self.hideChoices();},150);};AutoCompleteField.prototype.mouseHandler=function(e){e=(e||window.event);var elm=(e.target||e.srcElement);switch(e.type){case'mouseover':if(elm==this.autoComplete)this.overChoices=true;break;case'mouseout':if(elm==this.autoComplete)this.overChoices=false;break;case'scroll':this.fld.focus();break;}};AutoCompleteField.prototype.choiceHoverHandler=function(e){var elm=e.findElement('li');if(elm&&elm.index){if(e.type=='mouseover')(elm.index!=this.selectedIndex)&&(elm.className=this.options.style.hover);else elm.className=(elm.index==this.selectedIndex?this.options.style.selected:this.options.style.normal);}};AutoCompleteField.prototype.choiceClickHandler=function(e){var elm=e.findElement('li');if(elm&&!Object.isUndef(elm.index)){this.chooseByIndex(elm.index);e.stop();}};AutoCompleteField.prototype.navigate=function(fw){if(this.choiceCount>0){this.showChoices();var it=this.choiceItems,ac=this.autoComplete;if(this.selectedIndex>-1)it[this.selectedIndex].className=this.options.style.normal;this.selectedIndex=(fw>0 ?(this.selectedIndex+fw<this.choiceCount?this.selectedIndex+fw:0):(this.selectedIndex+fw>=0?this.selectedIndex+fw:this.choiceCount-1));it[this.selectedIndex].className=this.options.style.selected;if(it[this.selectedIndex].offsetTop<ac.scrollTop||it[this.selectedIndex].offsetTop>ac.offsetHeight)ac.scrollTop=it[this.selectedIndex].offsetTop;}else{this.choosing=false;this.hideChoices();}};AutoCompleteField.prototype.chooseByIndex=function(idx){var res,itemText,item=this.choiceItems[idx];if(this.options.choiceValueNode&&(res=item.getElementsByTagName(this.options.choiceValueNode))){itemText=res[0].innerHTML.stripTags();}else{itemText=item.innerHTML.stripTags();}if(this.options.incremental){var tokPos=this.findLastSeparator();if(tokPos!=-1){var blank=this.fld.value.substr(tokPos+1).match(/^\s+/);this.fld.value=this.lastValue=this.fld.value.substr(0,tokPos+1)+(blank?blank[0]:'')+itemText+this.options.separator+' ';}else{this.fld.value=this.lastValue=itemText+this.options.separator+' ';}}else{this.fld.value=itemText;}this.hideChoices();this.raiseEvent('change');this.fld.focus();};AutoCompleteField.prototype.getLastToken=function(){if(this.options.incremental){var tokPos=this.findLastSeparator();if(tokPos!=-1)return this.fld.value.substr(tokPos+1).trim();}return this.fld.value;};AutoCompleteField.prototype.findLastSeparator=function(){return this.fld.value.lastIndexOf(this.options.separator);};PHP2Go.included[PHP2Go.baseUrl+'form/autocompletefield.js']=true;}