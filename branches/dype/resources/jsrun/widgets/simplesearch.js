if(!PHP2Go.included[PHP2Go.baseUrl+'widgets/simplesearch.js']){PHP2Go.include(PHP2Go.baseUrl+'inputmask.js');PHP2Go.include(PHP2Go.baseUrl+'validator.js');ReportSimpleSearch=function(instanceName,masks,searchUrl){this.name=instanceName;this.searchUrl=searchUrl||document.location.pathname;this.fields=$(this.name+'_search_fields');this.operators=$(this.name+'_search_operators');this.masks=masks||[];this.term=$(this.name+'_search_term');this.form=this.fields.form;this.buttons={send:$(this.name+'_search_send'),add:$(this.name+'_search_add'),view:$(this.name+'_search_view'),clear:$(this.name+'_search_clear')};this.display=$(this.name+'_filters');this.displayVisible=false;this.filters=[];this.changed=false;this.onSearch=null;this.lastOpType;this.setup();};ReportSimpleSearch.prototype.setup=function(){var strFilters=Cookie.get(this.name+'_filters');if(strFilters){this.filters=strFilters.split('@@');this.buildFilters();this.toggleFiltersDisplay();}else{this.buildFilters();}var self=this;Event.addListener(this.fields,'change',function(e){var mask=self.getCurrentMask();if(mask){var newMask=Mask.fromMaskName(mask);self.term.inputMask.mask=newMask;self.term.value='';self.rebuildOperators();};});Event.addListener(this.term,'keypress',function(e){e=$EV(e);if(e.key()==13){self.sendSearch();e.stop();}});InputMask.setup(this.term,NullMask);Event.addListener(this.buttons.send,'click',this.sendSearch.bind(this));Event.addListener(this.buttons.add,'click',function(){self.addFilter(true);});Event.addListener(this.buttons.view,'click',this.toggleFiltersDisplay.bind(this));Event.addListener(this.buttons.clear,'click',this.clearFilters.bind(this));};ReportSimpleSearch.prototype.getCurrentMask=function(){var filt=this.fields.selectedIndex;if(filt>0)return this.masks[filt-1];return null;};ReportSimpleSearch.prototype.buildFilters=function(){var self=this;var j=0,savedFilters=this.filters.map(function(item){var splitted=item.split('|');return("<tr><td style=\"width:100%;padding:4px;\">"+"<div style=\"float:left;\">"+splitted[0]+" <b>"+splitted[1].toUpperCase()+"</b> "+splitted[2]+"</div>"+"<div style=\"float:right;\"><a id=\""+item+"\" style=\"cursor:pointer;\">"+"<b>["+Lang.report.removeFilter+"]</b>"+"</a></div>"+"</td></tr>");}).join("");this.display.update("<table cellspacing=\"0\" style=\"width:100%;padding:2px;font-family:verdana;font-size:11px;color:#000000;text-decoration:none;background-color:#fff;border:1px solid #000\">"+"<tr id=\""+this.name+"_nofilters\" style=\"display:none;\"><td style=\"padding:4px;\">"+Lang.report.emptyFilters+"</td></tr>"+savedFilters+"<tr id=\""+this.name+"_closefilters\"><td style=\"padding:4px;\"><a id=\""+this.name+"_close\" style=\"float:right;cursor:pointer;\"><b>["+Lang.report.closeFilters+"]</b></a></td></tr>"+"</table>");$C(this.display.getElementsByTagName('a')).walk(function(item,idx){if(item.id==self.name+'_close')Event.addListener(item,'click',self.toggleFiltersDisplay.bind(self));else Event.addListener(item,'click',self.removeFilter.bind(self));});if(this.filters.length==0)$(this.name+'_nofilters').show();};ReportSimpleSearch.prototype.rebuildOperators=function(){var filt=this.fields,trg=this.operators;if(filt.selectedIndex>0){var src,mask=this.masks[filt.selectedIndex-1].replace(/[^A-Z]/,"");var type=(['WORD','EMAIL','URL','ZIP','STRING'].indexOf(mask)!=-1?'text':'numeric');if(!this.lastOpType||type!=this.lastOpType){this.lastOpType=type;trg.options.length=0;src=(['WORD','EMAIL','URL','ZIP','STRING'].indexOf(mask)!=-1?$H(Lang.report.stringOperators):$H(Lang.report.numberOperators));src.walk(function(item,idx){trg.options[idx]=new Option(item.value,item.key);});}else{trg.options[0].selected=true;}}};ReportSimpleSearch.prototype.isValidSearch=function(focus){focus=!!focus;var f=this.fields,t=this.term;if(f.selectedIndex<1){(focus)&&(f.focus());return false;}if(t.value.trim()==""){(focus)&&(t.focus());return false;}if(!this.validateTerm(t.value)){alert(Lang.invalidValue);(focus)&&(t.select());return false;}return true;};ReportSimpleSearch.prototype.validateTerm=function(val){try{var mask=this.getCurrentMask();return(mask=='STRING'?true:Validator.isMask(this.term.value,mask));}catch(e){return false;}};ReportSimpleSearch.prototype.sendSearch=function(e){var send=(this.addFilter(false)||(this.filters.length>0&&(this.changed||confirm(Lang.report.resendConfirmation))));if(send){var fl=[],ol=[],vl=[];this.filters.walk(function(item,idx){var splitted=item.split('|');fl.push(splitted[3]);ol.push(splitted[4]);vl.push(splitted[2]);});$(this.name+'_search_serialized_fields').value=fl.join("|");$(this.name+'_search_serialized_operators').value=ol.join("|");$(this.name+'_search_serialized_values').value=vl.join("|");Cookie.set(this.name+"_mainop",($(this.name+'_search_mainop_and').checked?'AND':'OR'),Cookie.buildLifeTime(0,0,10));if(this.onSearch)this.onSearch();this.form.submit();}};ReportSimpleSearch.prototype.addFilter=function(verbose){var f,o,t,trg,expr,idx;if(this.isValidSearch(true)){f=this.fields,o=this.operators,t=this.term;expr=f.options[f.selectedIndex].text+"|"+o.options[o.selectedIndex].text+"|"+t.value+"|"+f.options[f.selectedIndex].value+"|"+o.options[o.selectedIndex].value;if(this.filters.indexOf(expr)==-1){if(this.filters.length==0)$(this.name+'_nofilters').hide();this.filters.push(expr);this.changed=true;Cookie.set(this.name+"_filters",this.filters.join("@@"),Cookie.buildLifeTime(0,0,10));var tr=$N('tr');var td=$N('td',tr,{'width':'100%','padding':'4px'},"<div style=\"float:left;\">"+f.options[f.selectedIndex].text+" <b>"+o.options[o.selectedIndex].text.toUpperCase()+"</b> "+t.value+"</div>"+"<div style=\"float:right;\"><a id=\""+expr+"\" style=\"cursor:pointer;\">"+"<b>["+Lang.report.removeFilter+"]</b>"+"</a></div>");trg=$(this.name+'_closefilters');trg.parentNode.insertBefore(tr,trg);Event.addListener(tr.getElementsByTagName('a')[0],'click',this.removeFilter.bind(this));if(verbose){alert(Lang.report.addedFilter);!this.displayVisible&&this.toggleFiltersDisplay();}return true;}else{if(verbose)alert(Lang.duplicatedValue);}}return false;};ReportSimpleSearch.prototype.removeFilter=function(e){var f=this.filters,elm=$EV(e).target;f.remove(f.indexOf(elm.getParentByTagName('a').id));if(f.length==0)$(this.name+'_nofilters').show();Cookie.set(this.name+"_filters",f.join("@@"),Cookie.buildLifeTime(0,0,10));elm.getParentByTagName('tr').remove();this.changed=true;};ReportSimpleSearch.prototype.toggleFiltersDisplay=function(){this.display.toggleDisplay();this.displayVisible=(this.display.getStyle('display')!='none');};ReportSimpleSearch.prototype.clearFilters=function(){Cookie.set(this.name+"_filters","",-3600);document.location.href=this.searchUrl;};PHP2Go.included[PHP2Go.baseUrl+'widgets/simplesearch.js']=true;}